<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="#{admin.manageReferees.title}">Gestionar Árbitros - CabaPro Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/globals.css}">
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a th:href="@{/admin/dashboard}" class="flex items-center space-x-2">
                        <i class="fas fa-arrow-left text-gray-600 hover:text-gray-800"></i>
                        <span class="text-gray-600 hover:text-gray-800" th:text="#{admin.backToDashboard}">Volver al
                            Dashboard</span>
                    </a>
                </div>
                <div class="flex items-center space-x-2">
                    <a th:href="@{?lang=es}" class="text-xs text-gray-500 hover:text-gray-700">ES</a>
                    <span class="text-gray-300">|</span>
                    <a th:href="@{?lang=en}" class="text-xs text-gray-500 hover:text-gray-700">EN</a>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Page Title -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900" th:text="#{admin.manageReferees.heading}">Gestionar Árbitros
            </h1>
            <p class="text-gray-600 mt-2" th:text="#{admin.manageReferees.subtitle}">Asigna árbitros a partidos según
                escalafón y especialidad</p>
        </div>

        <!-- Aquí puedes agregar un título o mensaje si lo deseas, pero sin filtros -->

        <!-- Partidos List -->
        <div class="space-y-6">
            <!-- Partido Card -->
            <div th:each="partido : ${partidos}"
                class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900">
                                <span th:text="${#temporals.format(partido.fecha, 'dd/MM/yyyy')}"></span>
                                <span th:text="${partido.hora}"></span>
                                <span th:text="${partido.lugar}"></span>
                            </h3>
                            <p class="text-gray-600" th:text="${partido.torneo.nombre}">Torneo de Baloncesto</p>
                        </div>
                        <div class="text-right">
                            <span th:if="${partido.asignaciones.size() == 0}"
                                class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                Sin asignar
                            </span>
                            <span th:if="${partido.asignaciones.size() > 0 && partido.asignaciones.size() < 3}"
                                class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                Parcialmente asignado
                            </span>
                            <span th:if="${partido.asignaciones.size() >= 3}"
                                class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Completamente asignado
                            </span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="flex items-center text-gray-600">
                            <i class="fas fa-calendar-alt mr-2 text-orange-600"></i>
                            <span th:text="${#temporals.format(partido.fecha, 'dd/MM/yyyy')}">15/12/2024</span>
                        </div>
                        <div class="flex items-center text-gray-600">
                            <i class="fas fa-clock mr-2 text-orange-600"></i>
                            <span th:text="${partido.hora}">19:30</span>
                        </div>
                        <div class="flex items-center text-gray-600">
                            <i class="fas fa-map-marker-alt mr-2 text-orange-600"></i>
                            <span th:text="${partido.lugar}">Lugar</span>
                        </div>
                    </div>

                    <!-- Árbitros Asignados -->
                    <div class="mb-6">
                        <h4 class="text-lg font-medium text-gray-900 mb-3" th:text="#{admin.manageReferees.assigned}">
                            Árbitros Asignados</h4>
                        <div th:if="${partido.asignaciones.size() > 0}" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div th:each="asignacion : ${partido.asignaciones}" class="bg-gray-50 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-medium text-gray-900"
                                        th:text="${asignacion.arbitro.nombre}">Nombre árbitro</span>
                                    <span th:if="${asignacion.estado.name() == 'ACEPTADA'}"
                                        class="text-green-600 text-sm">
                                        <i class="fas fa-check-circle"></i> <span
                                            th:text="#{admin.status.complete}">Aceptado</span>
                                    </span>
                                    <span th:if="${asignacion.estado.name() == 'PENDIENTE'}"
                                        class="text-yellow-600 text-sm">
                                        <i class="fas fa-clock"></i> <span
                                            th:text="#{admin.matches.pending}">Pendiente</span>
                                    </span>
                                    <span th:if="${asignacion.estado.name() == 'RECHAZADA'}"
                                        class="text-red-600 text-sm">
                                        <i class="fas fa-times-circle"></i> <span
                                            th:text="#{admin.status.unassigned}">Rechazado</span>
                                    </span>
                                </div>
                                <div class="text-sm text-gray-600">
                                    <span th:text="${asignacion.arbitro.escalafon}">FIBA</span> •
                                    <span th:text="${asignacion.arbitro.especialidad}">CAMPO</span>
                                </div>
                                <button class="mt-2 text-red-600 hover:text-red-800 text-sm"
                                    th:onclick="'removeAssignment(' + ${asignacion.id} + ')'">
                                    <i class="fas fa-trash mr-1"></i><span
                                        th:text="#{admin.manageReferees.remove}">Remover</span>
                                </button>
                            </div>
                        </div>
                        <div th:if="${partido.asignaciones.size() == 0}" class="text-gray-500 text-center py-8">
                            <i class="fas fa-user-slash text-4xl mb-2"></i>
                            <p th:text="#{admin.manageReferees.noAssigned}">No hay árbitros asignados a este partido</p>
                        </div>
                    </div>

                    <!-- Assign Referee Button -->
                    <div class="flex justify-end">
                        <button class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors"
                            th:onclick="'openAssignModal(' + ${partido.id} + ')'">
                            <i class="fas fa-plus mr-2"></i><span
                                th:text="#{admin.manageReferees.assignReferee}">Asignar Árbitro</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div th:if="${partidos.size() == 0}" class="text-center py-12">
                <i class="fas fa-calendar-times text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-medium text-gray-900 mb-2" th:text="#{admin.manageReferees.emptyTitle}">No hay
                    partidos disponibles</h3>
                <p class="text-gray-600 mb-4" th:text="#{admin.manageReferees.emptySubtitle}">Crea un partido para
                    comenzar a asignar árbitros</p>
                <a th:href="@{/admin/crear-partido}"
                    class="inline-flex items-center px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i><span th:text="#{admin.manageReferees.createMatch}">Crear
                        Partido</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Assignment Modal -->
    <div id="assignModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-96 overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Asignar Árbitro</h3>
                        <button onclick="closeAssignModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Referee Selection -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2"
                                th:text="#{admin.manageReferees.filterRank}">Filtrar por escalafón</label>
                            <select id="escalafon-filter"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                <option value="">Todos</option>
                                <option value="FIBA">FIBA</option>
                                <option value="PRIMERA">Primera</option>
                                <option value="SEGUNDA">Segunda</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2"
                                th:text="#{admin.manageReferees.filterRole}">Filtrar por especialidad</label>
                            <select id="especialidad-filter"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500">
                                <option value="">Todas</option>
                                <option value="PRINCIPAL">Principal</option>
                                <option value="ASISTENTE">Asistente</option>
                                <option value="CRONOMETRISTA">Cronometrista</option>
                                <option value="ANOTADOR">Anotador</option>
                            </select>
                        </div>

                        <!-- Available Referees -->
                        <div class="max-h-64 overflow-y-auto">
                            <h4 class="text-sm font-medium text-gray-700 mb-2"
                                th:text="#{admin.manageReferees.available}">Árbitros Disponibles</h4>
                            <div id="available-referees" class="space-y-2">
                                <div th:each="arbitro : ${arbitros}"
                                    class="referee-card border border-gray-200 rounded-lg p-3 hover:bg-gray-50 cursor-pointer"
                                    th:data-escalafon="${arbitro.escalafon}"
                                    th:data-especialidad="${arbitro.especialidad}"
                                    th:attr="data-correo=${arbitro.correo},data-nombre=${arbitro.nombre}"
                                    onclick="selectReferee(this)">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="font-medium text-gray-900" th:text="${arbitro.nombre}">Nombre
                                                árbitro</p>
                                            <p class="text-sm text-gray-600">
                                                <span th:text="${arbitro.escalafon}">FIBA</span> •
                                                <span th:text="${arbitro.especialidad}">PRINCIPAL</span>
                                            </p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-sm font-medium text-green-600"
                                                th:text="#{admin.manageReferees.availableStatus}">Disponible</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="closeAssignModal()"
                            class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">
                            <span th:text="#{admin.cancel}">Cancelar</span>
                        </button>
                        <button id="confirm-assignment" onclick="confirmAssignment()"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                            disabled>
                            <span th:text="#{admin.manageReferees.confirm}">Asignar Árbitro</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        let selectedPartidoId = null;
        let selectedArbitroCorreo = null;

        function openAssignModal(partidoId) {
            selectedPartidoId = partidoId;
            document.getElementById('assignModal').classList.remove('hidden');
        }

        function closeAssignModal() {
            document.getElementById('assignModal').classList.add('hidden');
            selectedPartidoId = null;
            selectedArbitroCorreo = null;
            document.getElementById('confirm-assignment').disabled = true;
            // Reset selection
            document.querySelectorAll('.referee-card').forEach(card => {
                card.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
            });
        }

        function selectReferee(element) {
            selectedArbitroCorreo = element.getAttribute('data-correo');
            // Reset all cards
            document.querySelectorAll('.referee-card').forEach(card => {
                card.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
            });
            // Highlight selected card
            element.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
            // Enable confirm button
            document.getElementById('confirm-assignment').disabled = false;
        }

        function confirmAssignment() {
            if (selectedPartidoId && selectedArbitroCorreo) {
                // Send assignment request
                fetch('/admin/asignar-arbitro', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        partidoId: selectedPartidoId,
                        arbitroCorreo: selectedArbitroCorreo
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('[[#{admin.error.assign}]]: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('[[#{admin.error.assign}]]');
                    });

                closeAssignModal();
            }
        }

        function removeAssignment(asignacionId) {
            if (confirm('[[#{admin.manageReferees.removeConfirm}]]')) {
                fetch('/admin/remover-asignacion/' + asignacionId, {
                    method: 'DELETE'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('[[#{admin.error.remove}]]: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('[[#{admin.error.remove}]]');
                    });
            }
        }

        // Filter functionality
        document.getElementById('escalafon-filter').addEventListener('change', filterReferees);
        document.getElementById('especialidad-filter').addEventListener('change', filterReferees);

        function filterReferees() {
            const escalafon = document.getElementById('escalafon-filter').value;
            const especialidad = document.getElementById('especialidad-filter').value;

            document.querySelectorAll('.referee-card').forEach(card => {
                const cardEscalafon = card.dataset.escalafon;
                const cardEspecialidad = card.dataset.especialidad;

                const showCard = (!escalafon || cardEscalafon === escalafon) &&
                    (!especialidad || cardEspecialidad === especialidad);

                card.style.display = showCard ? 'block' : 'none';
            });
        }
    </script>
</body>

</html>